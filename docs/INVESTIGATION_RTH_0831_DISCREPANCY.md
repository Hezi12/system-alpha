# תחקיר: חריגה בכניסה 08:31 – NinjaTrader vs SYSTEM_ALPHA

## סיכום מנהלים

**תוצאה:** הכניסה בשעה **08:31** שמופיעה בנינג'ה טריידר **חסרה** ב‑SYSTEM_ALPHA.

**סיבה עיקרית:** פילטר ה‑RTH במערכת **מתחיל ב־08:31** (`minutes >= 511`) במקום **08:30** (`minutes >= 510`).  
**נר 08:30** (הראשון של RTH) **לא נכלל** בנתונים שעליהם רץ הבקטסט, ולכן התנאי RSI לא נבדק עליו ולעולם לא מתקבל סיגנל כניסה שמביא לכניסה ב־08:31.

---

## 1. אסטרטגיית הנינג'ה טריידר (A1)

- **כניסה:** `RSI[0] > RSIEntryLevel` (ברירת מחדל 30)
- **יציאה:** `RSI[0] < RSIExitLevel` (ברירת מחדל 70)
- **RSI:** Period 14
- **Calculate:** `OnBarClose`
- **סשן:** RTH (מתחיל 08:30)

עם `OnBarClose`, הסיגנל נבדק **בסגירת** הנר. הכניסה מתבצעת ב־**open** של הנר **הבא**.

---

## 2. איך נוצרת הכניסה ב־08:31 בנינג'ה טריידר

1. **נר 08:30** (08:30–08:31) נסגר.
2. ב־**OnBarClose** מתבצעת הבדיקה: `RSI[0] > 30` על **נר 08:30**.
3. אם התנאי מתקיים → כניסה Long.
4. הביצוע בפועל ב־**פתיחת הנר הבא** = **08:31**.

כלומר: הנר **המפעיל** את הכניסה הוא **08:30**; השעה **08:31** היא שעת **הביצוע**.

---

## 3. סינון RTH ב‑SYSTEM_ALPHA

הקוד הרלוונטי: `App.jsx` שורות 3131–3137.

```javascript
if (config.sessionType === 'RTH') {
    let rthFiltered = filtered.filter(d => {
        const date = new Date(d.time * 1000);
        const minutes = date.getUTCHours() * 60 + date.getUTCMinutes();
        return minutes >= 511 && minutes <= 900; // 08:31 - 15:00
    });
    // ...
}
```

**משמעות:**

| ערך | חישוב | שעה |
|-----|--------|-----|
| 510 | 8×60 + 30 | **08:30** |
| 511 | 8×60 + 31 | **08:31** |
| 900 | 15×60 + 0 | 15:00 |

- התנאי: `minutes >= 511` → כלומר **מ־08:31 ואילך**.
- נר עם **timestamp 08:30** → `minutes = 510` → **510 < 511** → **הנר נזרק**.

לכן **נר 08:30 לא נכלל בכלל** בנתונים שעליהם רצים הבקטסט והאסטרטגיה.

---

## 4. זרימת הנתונים והבקטסט

1. **עדכון נתונים** (`useEffect` שב־3122):
   - `rawData` → סינון שנים → אם `sessionType === 'RTH'` → סינון RTH (`>= 511`, `<= 900`).
   - תוצאה: `filtered` **בלי** נר 08:30.

2. **עיבוד:**
   - `processData(filtered, primaryTimeframe)` → `processedData`.
   - הבקטסט רץ על `processedData`.

3. **בקטסט (A1):**
   - לולאה על `data[i]` (נרות מ־processedData).
   - אין נר 08:30, אז **לעולם לא** בודקים RSI על נר 08:30.
   - אין סיגנל כניסה על סגירת 08:30 → **אין כניסה ב־08:31**.

כלומר החריגה **לא** נובעת מלוגיקת התנאים (RSI וכו'), אלא מכך ש**נר 08:30 לא מגיע בכלל לבקטסט** בגלל פילטר ה‑RTH.

---

## 5. התאמה לנינג'ה טריידר

- בנינג'ה, RTH ל‑NQ מתחיל ב־**08:30**. הנר הראשון של RTH הוא **08:30**.
- הכניסה "ב־08:31" היא ביצוע ב‑**open** של נר 08:31, אחרי סיגנל על **סגירת** נר 08:30.

כדי להתאים התנהגות:

- RTH צריך **להתחיל ב־08:30**, לא ב־08:31.
- כלומר לכלול נרות עם `minutes >= 510` (08:30) ולא `>= 511` (08:31).

**שינוי מוצע (רק כאפשרות, לא מיושם):**

- מ‑`minutes >= 511` ל‑`minutes >= 510` כדי לכלול את נר 08:30.
- התאמת סיום RTH (למשל 15:15 במקום 15:00) היא נושא נפרד ולא מטופל בתחקיר זה.

---

## 6. סיכום ופעולות מומלצות

| נושא | ממצא |
|------|------|
| **סיבת החריגה** | נר 08:30 נחתך על ידי פילטר RTH (`>= 511`) ולכן לא משתתף בבקטסט. |
| **מיקום הקוד** | `App.jsx` ~שורה 3136: `return minutes >= 511 && minutes <= 900;` |
| **התאמה ל‑NT** | התחלת RTH ב‑08:30 → `minutes >= 510` (כולל 08:30). |
| **תלות ב‑sessionType** | הבעיה מופיעה **רק** כש־`config.sessionType === 'RTH'`; ב‑FULL/24H נר 08:30 נשאר. |

**המלצה:** לעדכן את תחילת חלון ה‑RTH מ־08:31 ל־08:30 (כלומר `>= 510`) ולבדוק שוב מול הנינג'ה טריידר.  
בתחקיר זה **לא בוצעו שינויים בקוד** – רק תיעוד וניתוח.

---

*נוצר: תחקיר דיוק תנאים – NinjaTrader vs SYSTEM_ALPHA.*
